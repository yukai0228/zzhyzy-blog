(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{184:function(e,t,a){"use strict";a.r(t);var s=a(0),r=Object(s.a)({},function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"content"},[e._m(0),e._v(" "),a("BlogPostMeta"),e._v(" "),a("p"),e._m(1),a("p"),e._v(" "),e._m(2),e._v(" "),a("p",[e._v("两台服务器都要相互设置")]),e._v(" "),e._m(3),e._m(4),e._v(" "),e._m(5),e._v(" "),e._m(6),e._v(" "),e._m(7),a("ul",[a("li",[e._v("下载并安装 "),a("a",{attrs:{href:"https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.24-1.el7.x86_64.rpm-bundle.tar",target:"_blank",rel:"noopener noreferrer"}},[e._v("MySQL5.7.24"),a("OutboundLink")],1)])]),e._v(" "),e._m(8),e._m(9),e._v(" "),e._m(10),e._v(" "),e._m(11),e._v(" "),e._m(12),e._m(13),e._v(" "),e._m(14),e._m(15),e._v(" "),e._m(16),e._v(" "),e._m(17),e._m(18),e._v(" "),e._m(19),e._m(20),e._v(" "),e._m(21),e._m(22),e._v(" "),e._m(23),e._m(24),e._v(" "),e._m(25),e._m(26),e._v(" "),e._m(27),e._m(28),e._v(" "),e._m(29),e._m(30),e._v(" "),e._m(31),e._v(" "),e._m(32),e._m(33),e._v(" "),e._m(34),e._v(" "),e._m(35),e._v(" "),e._m(36),e._m(37),e._v(" "),e._m(38),e._m(39),e._v(" "),e._m(40),e._m(41),e._v(" "),e._m(42),e._v(" "),e._m(43)],1)},[function(){var e=this.$createElement,t=this._self._c||e;return t("h1",{attrs:{id:"centos7-5-mysql5-7-24-mha0-58高可用架构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#centos7-5-mysql5-7-24-mha0-58高可用架构","aria-hidden":"true"}},[this._v("#")]),this._v(" CentOS7.5+MySQL5.7.24+MHA0.58高可用架构")])},function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"table-of-contents"},[a("ul",[a("li",[a("a",{attrs:{href:"#设置各主机间免密登录"}},[e._v("设置各主机间免密登录")])]),a("li",[a("a",{attrs:{href:"#软件安装"}},[e._v("软件安装")]),a("ul",[a("li",[a("a",{attrs:{href:"#安装mysql-5-7-24"}},[e._v("安装MySQL 5.7.24")])]),a("li",[a("a",{attrs:{href:"#配置mysql主从环境"}},[e._v("配置MySQL主从环境")])]),a("li",[a("a",{attrs:{href:"#安装mha-0-58"}},[e._v("安装MHA 0.58")])]),a("li",[a("a",{attrs:{href:"#配置mha"}},[e._v("配置MHA")])])])]),a("li",[a("a",{attrs:{href:"#配置vip漂移"}},[e._v("配置VIP漂移")]),a("ul",[a("li",[a("a",{attrs:{href:"#mha脚本方式"}},[e._v("MHA脚本方式")])]),a("li",[a("a",{attrs:{href:"#keepalive方式"}},[e._v("keepalive方式")])])])])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h2",{attrs:{id:"设置各主机间免密登录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#设置各主机间免密登录","aria-hidden":"true"}},[this._v("#")]),this._v(" 设置各主机间免密登录")])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("ssh-keygen\nssh-copy-id -i /root/.ssh/id_rsa.pub root@192.168.0.45\nssh-copy-id -i /root/.ssh/id_rsa.pub root@192.168.0.5\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h2",{attrs:{id:"软件安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#软件安装","aria-hidden":"true"}},[this._v("#")]),this._v(" 软件安装")])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"安装mysql-5-7-24"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装mysql-5-7-24","aria-hidden":"true"}},[this._v("#")]),this._v(" 安装MySQL 5.7.24")])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("删除系统自带的Mariadb数据库")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("rpm -qa|grep mariadb\nrpm -e --nodeps mariadb-libs-5.5.56-2.el7.x86_64\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("tar -xf mysql-5.7.24-1.el7.x86_64.rpm-bundle.tar\nrpm -ivh mysql-community-common-5.7.24-1.el7.x86_64.rpm \nrpm -ivh mysql-community-libs-5.7.24-1.el7.x86_64.rpm\nrpm -ivh mysql-community-client-5.7.24-1.el7.x86_64.rpm\nrpm -ivh mysql-community-server-5.7.24-1.el7.x86_64.rpm \nrpm -ivh mysql-community-libs-compat-5.7.24-1.el7.x86_64.rpm\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("MySQL目录")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("blockquote",[t("p",[this._v("数据库目录：/var/lib/mysql/\n命令配置：/usr/share/mysql  (mysql.server命令及配置文件)\n相关命令：/usr/bin   (mysqladmin mysqldump等命令)\n启动脚本：/etc/rc.d/init.d/   (启动脚本文件mysql的目录)\n系统配置：/etc/my.conf")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("设置密码")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("cat /var/log/mysqld.log # 获取默认密码\nmysql -u root -p\nset password = password('你的密码')\ngrant all privileges on *.* to 'root' @'%' identified by '你的密码';\nflush privileges;\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("开机自启")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("chkconfig mysqld on\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"配置mysql主从环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置mysql主从环境","aria-hidden":"true"}},[this._v("#")]),this._v(" 配置MySQL主从环境")])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("MySQL主节点的配置如下:")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("[mysqld]\nlog-bin=mysql-bin \nserver-id=1\ncharacter-set-server=utf8\ninit_connect='SET AUTOCOMMIT=0;set names utf8'\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("MySQL从节点的配置如下")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("[mysqld]\nlog-bin=mysql-bin \nserver-id=2\ncharacter-set-server=utf8\ninit_connect='SET AUTOCOMMIT=0;set names utf8'\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("创建需要复制的用户")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("CREATE USER 'repl'@'192.168.0.5' IDENTIFIED BY '密码';\nGRANT REPLICATION SLAVE ON *.* TO 'repl'@'192.168.0.5';\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("同步数据")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("mysql> FLUSH TABLES WITH READ LOCK; # 将主库锁定\nmysql> show master status;\nmysqldump --all-databases --master-data -u root -p > school.sql #备份主库\nmysql> unlock tables; #解锁\nscp school.sql root@192.168.0.5:/data/mysql #同步数据\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("从库开启主从复制")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("mysql -u root -p </data/mysql/school.sql \nmysql> change master to master_host = '192.168.0.45',master_port=3306,master_user='repl',master_password='密码',master_log_file='mysql-bin.000002',master_log_pos=154;\nmysql> start slave;\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("设置mysql程序及binglog程序的软连接")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("ln -s /usr/local/mysql/bin/mysql /usr/bin/mysql\nln -s /usr/local/mysql/bin/mysqlbinlog /usr/local/bin/mysqlbinlog\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"安装mha-0-58"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装mha-0-58","aria-hidden":"true"}},[this._v("#")]),this._v(" 安装MHA 0.58")])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("#先安装依赖\nwget http://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm\nrpm -ivh epel-release-latest-7.noarch.rpm\nwget https://www.percona.com/downloads/Percona-XtraDB-Cluster-LATEST/Percona-XtraDB-Cluster-5.7.24-31.33/binary/redhat/7/x86_64/Percona-XtraDB-Cluster-shared-57-5.7.24-31.33.1.el7.x86_64.rpm\nrpm -ivh Percona-XtraDB-Cluster-shared-57-5.7.24-31.33.1.el7.x86_64.rpm \nyum install perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager　-y\n\nwget https://github.com/yoshinorim/mha4mysql-node/releases/download/v0.58/mha4mysql-node-0.58-0.el7.centos.noarch.rpm\nrpm -ivh mha4mysql-node-0.58-0.el7.centos.noarch.rpm\n\n#仅在manager节点上安装mha管理软件\nyum install perl-Parallel-ForkManager  \nwget https://github.com/yoshinorim/mha4mysql-manager/releases/download/v0.58/mha4mysql-manager-0.58-0.el7.centos.noarch.rpm\nrpm -ivh mha4mysql-manager-0.58-0.el7.centos.noarch.rpm\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"配置mha"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置mha","aria-hidden":"true"}},[this._v("#")]),this._v(" 配置MHA")])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("创建配置文件")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("[server default] \nuser=root \npassword=数据库密码\nssh_user=root \nmanager_workdir=/data/mha/manager\nremote_workdir=/tmp\nrepl_user=repl \nrepl_password=数据库密码\n[server1] \nhostname=192.168.0.45\nport=3306\nmaster_binlog_dir=/var/lib/mysql\n \n[server2] \nhostname=192.168.0.5\nport=3306 \nmaster_binlog_dir=/var/lib/mysql\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("MHA主要配置文件说明")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("blockquote",[t("p",[this._v('manager_workdir=/var/log/masterha/app1.log：设置manager的工作目录     \nmanager_log=/var/log/masterha/app1/manager.log：设置manager的日志文件  \nmaster_binlog_dir=/data/mysql：设置master 保存binlog的位置，以便MHA可以找到master的日志                      \nmaster_ip_failover_script= /usr/local/bin/master_ip_failover：设置自动failover时候的切换脚本\nmaster_ip_online_change_script= /usr/local/bin/master_ip_online_change：设置手动切换时候的切换脚本 \nuser=root：设置监控mysql的用户\npassword=manager123：设置监控mysql的用户，需要授权能够在manager节点远程登录\nping_interval=1：设置监控主库，发送ping包的时间间隔，默认是3秒，尝试三次没有回应的时候自动进行railover    \nremote_workdir=/tmp：设置远端mysql在发生切换时binlog的保存位置\nrepl_user=repl ：设置mysql中用于复制的用户密码\nrepl_password=repl：设置mysql中用于复制的用户        \nreport_script=/usr/local/send_report：设置发生切换后发送的报警的脚本 \nshutdown_script=""：设置故障发生后关闭故障主机脚本（该脚本的主要作用是关闭主机放在发生脑裂,这里没有使用）\nssh_user=root //设置ssh的登录用户名\ncandidate_master=1：在节点下设置，设置当前节点为候选的master\nslave check_repl_delay=0 :在节点配置下设置，默认情况下如果一个slave落后master 100M的relay logs的话，MHA将不会选择该slave作为一个新的master；这个选项对于对于设置了candidate_master=1的主机非常有用')])])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("用masterha_check_ssh检测SSH连接是否配置正常")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("[root@server-0004 manager]# masterha_check_ssh --conf=/data/mha/manager/manager.conf\nWed Jan  9 17:59:08 2019 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.\nWed Jan  9 17:59:08 2019 - [info] Reading application default configuration from /data/mha/manager/manager.conf..\nWed Jan  9 17:59:08 2019 - [info] Reading server configuration from /data/mha/manager/manager.conf..\nWed Jan  9 17:59:08 2019 - [info] Starting SSH connection tests..\nWed Jan  9 17:59:09 2019 - [debug] \nWed Jan  9 17:59:08 2019 - [debug]  Connecting via SSH from root@192.168.0.45(192.168.0.45:22) to root@192.168.0.5(192.168.0.5:22)..\nWed Jan  9 17:59:09 2019 - [debug]   ok.\nWed Jan  9 17:59:09 2019 - [debug] \nWed Jan  9 17:59:09 2019 - [debug]  Connecting via SSH from root@192.168.0.5(192.168.0.5:22) to root@192.168.0.45(192.168.0.45:22)..\nWed Jan  9 17:59:09 2019 - [debug]   ok.\nWed Jan  9 17:59:09 2019 - [info] All SSH connection tests passed successfully.\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("用masterha_check_repl检测复制配置是否正确")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("masterha_check_repl --conf=/data/mha/manager/manager.conf\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("ul",[t("li",[this._v("启动manager")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("# 启动\nnohup masterha_manager --conf=/data/mha/manager/manager.conf > /var/log/mha_manager.log < /dev/null &\n# 检测运行状态\nmasterha_check_status --conf=/data/mha/manager/manager.conf\n# 停止\nmasterha_stop --conf=/data/mha/manager/manager.conf\n")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("h2",{attrs:{id:"配置vip漂移"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置vip漂移","aria-hidden":"true"}},[this._v("#")]),this._v(" 配置VIP漂移")])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"mha脚本方式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mha脚本方式","aria-hidden":"true"}},[this._v("#")]),this._v(" MHA脚本方式")])},function(){var e=this.$createElement,t=this._self._c||e;return t("h3",{attrs:{id:"keepalive方式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#keepalive方式","aria-hidden":"true"}},[this._v("#")]),this._v(" keepalive方式")])}],!1,null,null,null);r.options.__file="MySQL-MHA.md";t.default=r.exports}}]);